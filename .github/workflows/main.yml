name: Windows Build

on:
  workflow_dispatch:
  push:
    branches: [ windows-support ]
  pull_request:
    branches: [ windows-support ]

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      # -----------------------------
      # Checkout repo
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # Setup Haxe
      # -----------------------------
      - name: Setup Haxe 4.3.6
        uses: krdlab/setup-haxe@v1
        with:
          haxe-version: 4.3.6

      - name: Export HAXEPATH
        shell: bash
        run: |
          echo "HAXEPATH=$(dirname $(dirname $(which haxe)))" >> $GITHUB_ENV

      - name: Add Haxe to PATH (Windows)
        shell: powershell
        run: |
          echo "$env:HAXEPATH" | Out-File -FilePath $env:GITHUB_PATH -Append
      # -----------------------------
      # Install hmm + dependencies
      # -----------------------------
      - name: Install HMM
        shell: bash
        run: |
          haxelib --global install hmm
          haxelib --global run hmm setup
    
      - name: Install Libs
        run: |
          hmm install
      # -----------------------------
      # Force exact library versions
      # -----------------------------
      - name: Set haxelib versions
        shell: bash
        run: |
          haxelib set lime 8.1.3
          haxelib set openfl 9.3.4
          haxelib set flixel 6.1.0
          haxelib set flixel-ui 2.6.4
          haxelib set flixel-addons 3.3.2

      # -----------------------------
      # Build hxcpp tools + cppia
      # -----------------------------
      - name: Build hxcpp tools and cppia
        shell: bash
        run: |
          HXCPP_PATH=$(haxelib path hxcpp | head -n 1)
          cd "$HXCPP_PATH"

          echo "Building hxcpp tools..."
          cd tools/run
          haxe compile.hxml

          echo "Building hxcpp..."
          cd ../hxcpp
          haxe compile.hxml

          echo "Building cppia..."
          cd ../../project
          haxe compile-cppia.hxml

      # -----------------------------
      # Lime setup (Windows)
      # -----------------------------
      - name: Lime setup windows
        shell: bash
        run: |
          haxelib run lime setup windows

      # -----------------------------
      # Build Windows EXE
      # -----------------------------
      - name: Build Windows EXE
        shell: bash
        run: |
          haxelib run lime build windows -release -verbose

      # -----------------------------
      # Upload EXE artifact
      # -----------------------------
      - name: Upload Windows build
        uses: actions/upload-artifact@v4
        with:
          name: StickmanWindows-Release
          path: "export/**/*.exe"
